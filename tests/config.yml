---
init_tasks:
  - name: Add test domain
    type: mysql-client
    script: init_tasks/add_domain.sh
    args: {{ default_domain }}
  
  - name: Reload domains
    type: opensips-mi
    args: domain_reload
    require:
      after:
        task: Add test domain

  - name: Create caller
    type: opensips-cli
    args: -d -x user add {{ caller }}@{{ default_domain }} {{ caller_password }}
    require:
      after:
        task: Reload domains

  - name: Create callee
    type: opensips-cli
    args: -d -x user add {{ callee }}@{{ default_domain }} {{ callee_password }}
    require:
      after:
        task: Reload domains

  - name: Create call forward user
    type: opensips-cli
    args: -d -x user add {{ cf_user }}@{{ default_domain }} {{ cf_pass }}
    require:
      after:
        task: Reload domains
  
  - name: Enable caller
    type: mysql-client
    script: init_tasks/enable_user.sh
    args: {{ caller }} {{ default_domain }}
    require:
      after:
        task: Create caller
        wait: 1
    
  - name: Enable callee
    type: mysql-client
    script: init_tasks/enable_user.sh
    args: {{ callee }} {{ default_domain }}
    require:
      after:
        task: Create callee
        wait: 1

  - name: Enable call forward user
    type: mysql-client
    script: init_tasks/enable_user.sh
    args: {{ cf_user }} {{ default_domain }}
    require:
      after:
        task: Create call forward user
        wait: 1

  - name: Add did for callee
    type: mysql-client
    script: init_tasks/add_did.sh
    args: {{ callee }} {{ default_domain }} {{ callee_did }}

  - name: Add gateway 1
    type: mysql-client
    script: init_tasks/add_gateway.sh
    args:
      - gw-domain-test1
      - sip:{{ gateway1_ip }}:{{ gateway1_port }}
      - 'Gateway Test 1'

  - name: Add gateway 2
    type: mysql-client
    script: init_tasks/add_gateway.sh
    args:
      - gw-domain-test2
      - sip:{{ gateway2_ip }}:{{ gateway2_port }}
      - 'Gateway Test 2'

  - name: Add rule
    type: mysql-client
    script: init_tasks/add_rule.sh
    args:
      - {{ outgoing_did }}
      - gw-domain-test1,gw-domain-test2
      - 'Specific test DID routing'
    require:
      - after:
          task: Add gateway 1
      - after:
          task: Add gateway 2
  
  - name: MI reload dr
    type: opensips-mi
    args: dr_reload
    require:
      - after: Add rule


cleanup_tasks:
  - name: Delete rule
    type: mysql-client
    script: cleanup_tasks/delete_rule.sh
    args: {{ outgoing_did }}

  - name: Delete gateway 1
    type: mysql-client
    script: cleanup_tasks/delete_gateway.sh
    args: 'sip:{{ gateway1_ip }}:{{ gateway1_port }}'

  - name: Delete gateway 2
    type: mysql-client
    script: cleanup_tasks/delete_gateway.sh
    args: 'sip:{{ gateway2_ip }}:{{ gateway2_port }}'

  - name: MI reload gateway after delete
    type: opensips-mi
    args: dr_reload
    require:
      - after: Delete rule
      - after: Delete gateway 1
      - after: Delete gateway 2

  - name: Delete callee did
    type: mysql-client
    script: cleanup_tasks/delete_did.sh
    args: {{ callee_did }}

  - name: Delete caller
    type: opensips-cli
    args: -d -x user delete {{ caller }}@{{ default_domain }}

  - name: Delete callee
    type: opensips-cli
    args: -d -x user delete {{ callee }}@{{ default_domain }}

  - name: Delete call forward user
    type: opensips-cli
    args: -d -x user delete {{ cf_user }}@{{ default_domain }}

  - use: delete_caller_aor
  - use: delete_callee_aor
  - use: delete_cf_user_aor

  - name: Delete test domain
    type: mysql-client
    script: cleanup_tasks/remove_domain.sh
    args: {{ default_domain }}
    require:
      - after: Delete caller
      - after: Delete callee
  
  - name: Reload domains
    type: opensips-mi
    args: domain_reload
    require:
      after: Delete test domain


defaults:
  uac-sipp:
    proxy: {{ opensips_ip }}:{{ opensips_port }}
    keys:
      domain: {{ default_domain }}
      caller: {{ caller }}
      callee: {{ callee }}
  opensips-cli:
    mi_ip: {{ mi_ip }}
    options:
      database_user_url: mysql://{{ mysql_user }}:{{ mysql_password }}@{{ mysql_ip }}/{{ database }}
    network: softswitch-br
  opensips-mi:
    mi_ip: {{ mi_ip }}
    env:
      CONN: http
      URL: http://{{ mi_ip }}:8888/mi
    network: softswitch-br    
  mysql-client:
    host: {{ mysql_ip }}
    user: {{ mysql_user }}
    password: {{ mysql_password }}
    database: {{ database }}
    network: softswitch-br

task_templates:
  register_caller:
    type: uac-sipp
    username: {{ caller }}
    password: "{{ caller_password }}"
    config_file: scripts/sipp-register.xml
    ip: {{ caller_ip }}
    port: {{ caller_port }}
  register_callee:
    type: uac-sipp
    username: {{ callee }}
    password: "{{ callee_password }}"
    config_file: scripts/sipp-register.xml
    ip: {{ callee_ip }}
    port: {{ callee_port }}
  register_cf_user:
    type: uac-sipp
    username: {{ cf_user }}
    password: "{{ cf_pass }}"
    config_file: scripts/sipp-register.xml
    ip: {{ cf_ip }}
    port: {{ cf_port }}
  caller_uac:
    type: uac-sipp
    username: {{ caller }}
    password: "{{ caller_password }}"
    config_file: scripts/caller.xml
    ip: {{ caller_ip }}
    port: {{ caller_port }}
  callee_uas:
    type: uas-sipp
    username: {{ callee }}
    password: "{{ callee_password }}"
    config_file: scripts/callee.xml
    ip: {{ callee_ip }}
    port: {{ callee_port }}
  cf_user_uas:
    type: uas-sipp
    username: {{ cf_user }}
    password: "{{ cf_pass }}"
    config_file: scripts/cf-user.xml
    ip: {{ cf_ip }}
    port: {{ cf_port }}
  set_dnd_on:
    type: uac-sipp
    username: {{ callee }}
    password: "{{ callee_password }}"
    config_file: scripts/dnd_on.xml
    ip: {{ callee_ip }}
    port: {{ callee_port }}
  set_dnd_off:
    type: uac-sipp
    username: {{ callee }}
    password: "{{ callee_password }}"
    config_file: scripts/dnd_off.xml
    ip: {{ callee_ip }}
    port: {{ callee_port }}
  gateway_uas_1:
    type: uas-sipp
    config_file: scripts/gateway.xml
    ip: {{ gateway1_ip }}
    port: {{ gateway1_port }}
  gateway_uas_2:
    type: uas-sipp
    config_file: scripts/gateway.xml
    ip: {{ gateway2_ip }}
    port: {{ gateway2_port }}
  gateway_uac:
    type: uac-sipp
    config_file: scripts/gateway.xml
    ip: {{ gateway1_ip }}
    port: {{ gateway1_port }}
  delete_caller_aor:
    name: Delete caller AOR
    type: opensips-mi
    args: ul_rm location {{ caller }}@{{ default_domain }}
  delete_callee_aor:
    name: Delete callee AOR
    type: opensips-mi
    args: ul_rm location {{ callee }}@{{ default_domain }}
  delete_cf_user_aor:
    name: Delete call forward user AOR
    type: opensips-mi
    args: ul_rm location {{ cf_user }}@{{ default_domain }}
  check_callee_dnd_on:
    type: mysql-client
    script: scripts/check_dnd_on.sh
    args: {{ callee }} {{ default_domain }}
  check_callee_dnd_off:
    type: mysql-client
    script: scripts/check_dnd_off.sh
    args: {{ callee }} {{ default_domain }}
  disable_caller:
    name: Disable ACL caller
    type: mysql-client
    script: scripts/disable_user.sh
    args: {{ caller }} {{ default_domain }}
  disable_callee:
    name: Disable ACL callee
    type: mysql-client
    script: scripts/disable_user.sh
    args: {{ callee }} {{ default_domain }}
  enable_caller:
    name: Enable ACL caller
    type: mysql-client
    script: scripts/enable_user.sh
    args: {{ caller }} {{ default_domain }}
  enable_callee:
    name: Enable ACL callee
    type: mysql-client
    script: scripts/enable_user.sh
    args: {{ callee }} {{ default_domain }}
  enable_vm_callee:
    type: mysql-client
    script: scripts/enable_vm.sh
    args: {{ callee }} {{ default_domain }}
  disable_vm_callee:
    type: mysql-client
    script: scripts/disable_vm.sh
    args: {{ callee }} {{ default_domain }}
  add_cf_uri:
    type: mysql-client
    script: scripts/add_cf_uri.sh
    args: {{ callee }} {{ default_domain }} sip:{{ cf_user }}@{{ default_domain }}
  remove_cf_uri:
    type: mysql-client
    script: scripts/remove_cf_uri.sh
    args: {{ callee }} {{ default_domain }}
  allow_pstn_caller:
    type: mysql-client
    script: scripts/allow_pstn.sh
    args: {{ caller }} {{ default_domain }}
  deny_pstn_caller:
    type: mysql-client
    script: scripts/deny_pstn.sh
    args: {{ caller }} {{ default_domain }}
  check_caller_register:
    type: opensips-mi
    script: scripts/check-register.py
    args: {{ caller }}
  check_callee_register:
    type: opensips-mi
    script: scripts/check-register.py
    args: {{ callee }}