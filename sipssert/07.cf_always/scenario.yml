---
timeout: 60

tasks:
  - name: Enable call forward user
    type: mysql-client
    script: scripts/enable_user.sh
    args: {{ cf_user }} {{ default_domain }}

  - name: Register caller
    type: uac-sipp
    username: {{ caller }}
    password: "{{ caller_password }}"
    config_file: scripts/sipp-register.xml
    ip: {{ caller_ip }}
    port: {{ caller_port }}

  - name: Register call forward user
    type: uac-sipp
    username: {{ cf_user }}
    password: "{{ cf_pass }}"
    config_file: scripts/sipp-register.xml
    ip: {{ cf_ip }}
    port: {{ cf_port }}
    require:
      after:
        task: Enable call forward user
  
  - name: Add CF Always URI for callee
    type: mysql-client
    script: scripts/add_cf_uri.sh
    args: {{ callee }} {{ default_domain }} sip:{{ cf_user }}@{{ default_domain }}

  - name: Caller UAC
    type: uac-sipp
    username: {{ caller }}
    password: "{{ caller_password }}"
    config_file: scripts/caller.xml
    ip: {{ caller_ip }}
    port: {{ caller_port }}
    require:
      after: Register caller
      after: Register call forward user
      after: Add CF Always URI for callee
  
  - name: CF User UAC
    type: uas-sipp
    username: {{ cf_user }}
    password: "{{ cf_pass }}"
    config_file: scripts/cf-user.xml
    ip: {{ cf_ip }}
    port: {{ cf_port }}
    require:
      after: Register caller
      after: Register call forward user
      after: Add CF Always URI for callee
  
  - name: Register Callee
    type: uac-sipp
    username: {{ callee }}
    password: "{{ callee_password }}"
    config_file: scripts/sipp-register.xml
    ip: {{ callee_ip }}
    port: {{ callee_port }}
    require:
      after: Caller UAC
      after: CF User UAC
  
  - name: Caller UAC 2
    type: uac-sipp
    username: {{ caller }}
    password: "{{ caller_password }}"
    config_file: scripts/caller.xml
    ip: {{ caller_ip }}
    port: {{ caller_port }}
    require:
      after: Register Callee
  
  - name: CF User UAC 2
    type: uas-sipp
    username: {{ cf_user }}
    password: "{{ cf_pass }}"
    config_file: scripts/cf-user.xml
    ip: {{ cf_ip }}
    port: {{ cf_port }}
    require:
      after: Register Callee
  
  - name: Remove CF Always URI for callee
    type: mysql-client
    script: scripts/remove_cf_uri.sh
    args: {{ callee }} {{ default_domain }}
    require:
      after: Caller UAC 2
      after: CF User UAC 2

  - name: Disable call forward user
    type: mysql-client
    script: scripts/disable_user.sh
    args: {{ cf_user }} {{ default_domain }}
    require:
      after: Remove CF Always URI for callee
  
  - name: Delete caller AOR
    type: opensips-cli
    args: -d -x mi ul_rm location {{ caller }}@{{ default_domain }}
    require:
      after:
        task: Disable call forward user

  - name: Delete callee AOR
    type: opensips-cli
    args: -d -x mi ul_rm location {{ callee }}@{{ default_domain }}
    require:
      after:
        task: Disable call forward user
  
  - name: Delete call forward user AOR
    type: opensips-cli
    args: -d -x mi ul_rm location {{ cf_user }}@{{ default_domain }}
    require:
      after:
        task: Disable call forward user
