---
timeout: 40

tasks:
  - name: Register caller
    type: uac-sipp
    username: {{ caller }}
    password: "{{ caller_password }}"
    config_file: scripts/sipp-register.xml
    ip: {{ caller_ip }}
    port: {{ caller_port }}

  - name: Check callee not registered
    type: opensips-cli
    script: scripts/check-register.py
    args: {{ callee }}

  - name: Enable VM NOT FOUND for callee
    type: mysql-client
    script: scripts/enable_vm.sh
    args: {{ callee }} {{ default_domain }}
    require:
      after:
        task: Check callee not registered
        wait: 1

  - name: Caller UAC
    type: uac-sipp
    username: {{ caller }}
    password: "{{ caller_password }}"
    config_file: scripts/caller.xml
    ip: {{ caller_ip }}
    port: {{ caller_port }}
    require:
      - after:
          task: Enable VM NOT FOUND for callee
          wait: 1
      - after:
          task: Register caller
          wait: 1
  
  - name: Disable VM NOT FOUND for callee
    type: mysql-client
    script: scripts/disable_vm.sh
    args: {{ callee }} {{ default_domain }}
    require:
      after:
        task: Caller UAC
        wait: 1

  - name: Delete caller AOR
    type: opensips-cli
    args: -d -x mi ul_rm location {{ caller }}@{{ default_domain }}
    require:
      after:
        task: Caller UAC
        wait: 1
